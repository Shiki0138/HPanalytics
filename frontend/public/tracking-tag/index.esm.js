function t(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const i=16*Math.random()|0;return("x"===t?i:3&i|8).toString(16)})}function i(){return(null===performance||void 0===performance?void 0:performance.now)?performance.now()+performance.timeOrigin:Date.now()}function e(t){if(t.id)return`#${t.id}`;if(t.className){const i=t.className.toString().split(/\s+/).filter(Boolean);if(i.length>0)return`.${i[0]}`}return t.tagName.toLowerCase()}function s(t=window.location.href){const i=new URL(t),e={};return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(t=>{const s=i.searchParams.get(t);s&&(e[t.replace("utm_","")]=s)}),Object.keys(e).length>0?e:{}}function n(){var t,i,e,s,n;const{navigator:r,screen:o,window:h}=globalThis;return{userAgent:(null==r?void 0:r.userAgent)||"",screenResolution:o?`${o.width}x${o.height}`:"",viewportSize:h?`${h.innerWidth}x${h.innerHeight}`:"",devicePixelRatio:(null==h?void 0:h.devicePixelRatio)||1,language:(null==r?void 0:r.language)||(null==r?void 0:r.userLanguage)||"",timezone:(null===(s=null===(e=null===(i=null===(t=null===Intl||void 0===Intl?void 0:Intl.DateTimeFormat)||void 0===t?void 0:t.call(Intl))||void 0===i?void 0:i.resolvedOptions)||void 0===e?void 0:e.call(i))||void 0===s?void 0:s.timeZone)||"",connectionType:null===(n=null==r?void 0:r.connection)||void 0===n?void 0:n.effectiveType,isMobile:/Mobi|Android/i.test((null==r?void 0:r.userAgent)||""),isTouch:"ontouchstart"in h||(null==r?void 0:r.maxTouchPoints)>0}}function r(){return"undefined"!=typeof window&&"undefined"!=typeof document}function o(t,i=3){if(i<=0)return"[Object]";if(null==t)return t;if("function"==typeof t)return"[Function]";if("symbol"==typeof t)return"[Symbol]";if(t instanceof Error)return{name:t.name,message:t.message,stack:t.stack};if(t instanceof Date)return t.toISOString();if("object"!=typeof t)return t;if(Array.isArray(t))return t.slice(0,100).map(t=>o(t,i-1));const e={};let s=0;for(const[n,r]of Object.entries(t)){if(s>=50)break;e[n]=o(r,i-1),s++}return e}class h{constructor(){this.t=new Map}getItem(t){return this.t.get(t)||null}setItem(t,i){this.t.set(t,i)}removeItem(t){this.t.delete(t)}clear(){this.t.clear()}}class c{constructor(){this.i="ai_analytics_",!function(){if(!r())return!1;try{const t="__storage_test__";return window.localStorage.setItem(t,t),window.localStorage.removeItem(t),!0}catch(t){return!1}}()?!function(){if(!r())return!1;try{const t="__storage_test__";return window.sessionStorage.setItem(t,t),window.sessionStorage.removeItem(t),!0}catch(t){return!1}}()?this.o=new h:this.o=window.sessionStorage:this.o=window.localStorage}h(t){return`${this.i}${t}`}getItem(t,i){try{const e=this.o.getItem(this.h(t));return null===e?i||null:function(t,i){try{return JSON.parse(t)}catch(t){return i}}(e,i)}catch(t){return i||null}}setItem(t,i){try{this.o.setItem(this.h(t),function(t){try{return JSON.stringify(t)}catch(t){return"{}"}}(i))}catch(t){}}removeItem(t){try{this.o.removeItem(this.h(t))}catch(t){}}clear(){try{if(this.o instanceof h)return void this.o.clear();const t=[],i=this.o;for(let e=0;e<i.length;e++){const s=i.key(e);s&&s.startsWith(this.i)&&t.push(s)}t.forEach(t=>i.removeItem(t))}catch(t){}}getEventQueue(){return this.getItem("event_queue",[])}setEventQueue(t){const i=t.slice(-1e3);this.setItem("event_queue",i)}addToQueue(t){const i=this.getEventQueue();i.push(t),this.setEventQueue(i)}removeFromQueue(t){const i=this.getEventQueue(),e=new Set(t.map(t=>t.timestamp)),s=i.filter(t=>!e.has(t.timestamp));this.setEventQueue(s)}getSessionData(){return{sessionId:this.getItem("session_id"),userId:this.getItem("user_id"),lastActivity:this.getItem("last_activity"),userProperties:this.getItem("user_properties",{})}}setSessionId(t){this.setItem("session_id",t)}setUserId(t){this.setItem("user_id",t)}setLastActivity(t){this.setItem("last_activity",t)}setUserProperties(t){const i={...this.getItem("user_properties",{}),...t};this.setItem("user_properties",i)}clearSession(){this.removeItem("session_id"),this.removeItem("user_id"),this.removeItem("last_activity"),this.removeItem("user_properties")}getStorageSize(){try{let t=0;if(this.o instanceof h)for(const[i,e]of this.o.t)t+=i.length+e.length;else{const i=this.o;for(let e=0;e<i.length;e++){const s=i.key(e);if(s&&s.startsWith(this.i)){const e=i.getItem(s);t+=s.length+((null==e?void 0:e.length)||0)}}}return 2*t}catch(t){return 0}}isAvailable(){try{const t=this.h("__test__");this.o.setItem(t,"test");const i=this.o.getItem(t);return this.o.removeItem(t),"test"===i}catch(t){return!1}}getStorageType(){return this.o===window.localStorage?"localStorage":this.o===window.sessionStorage?"sessionStorage":"memory"}}class a{constructor(){this.u=new Set,this.l=new Set,this.p()}onMetric(t){return this.u.add(t),()=>this.u.delete(t)}p(){"undefined"!=typeof window&&"undefined"!=typeof document&&(this.v(),this.m(),this._(),this.I(),this.T())}S(t){this.l.has(t.name)||(this.l.add(t.name),this.u.forEach(i=>{try{i(t)}catch(t){}}))}P(t,i){const e={CLS:[.1,.25],FCP:[1800,3e3],FID:[100,300],LCP:[2500,4e3],TTFB:[800,1800]}[t];return e?i<=e[0]?"good":i<=e[1]?"needs-improvement":"poor":"good"}C(){if("undefined"!=typeof navigator&&"connection"in navigator){const t=performance.getEntriesByType("navigation")[0];return(null==t?void 0:t.type)||"navigate"}return"navigate"}v(){if(!("LayoutShift"in window))return;let t=0,i=[],e=0,s=[],n=this.F();const r=new PerformanceObserver(r=>{for(const o of r.getEntries()){const r=o;if(!r.hadRecentInput){this.k(r,n)?(e>t&&(t=e,i=s),n=this.F(),e=r.value,s=[o]):(e+=r.value,s.push(o))}}e>t&&(t=e,i=s)});try{r.observe({type:"layout-shift",buffered:!0});const e=()=>{this.S({name:"CLS",value:t,rating:this.P("CLS",t),entries:i,navigationType:this.C()})};document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&e()}),window.addEventListener("beforeunload",e)}catch(t){}}k(t,i){const e=!this.L,s=t.startTime-(this.L||0)>1e3,n=t.startTime-(this.O||t.startTime)>5e3;return e&&(this.O=t.startTime),this.L=t.startTime,e||s||n}F(){return Math.random().toString(36).substring(2)}m(){const t=new PerformanceObserver(i=>{for(const e of i.getEntries())if("first-contentful-paint"===e.name){this.S({name:"FCP",value:e.startTime,rating:this.P("FCP",e.startTime),entries:[e],navigationType:this.C()}),t.disconnect();break}});try{t.observe({type:"paint",buffered:!0})}catch(t){}}_(){const t=new PerformanceObserver(i=>{for(const e of i.getEntries()){const i=e,s=i.processingStart-i.startTime;this.S({name:"FID",value:s,rating:this.P("FID",s),entries:[e],navigationType:this.C()}),t.disconnect();break}});try{t.observe({type:"first-input",buffered:!0})}catch(t){}}I(){let t=0,i=null;const e=new PerformanceObserver(e=>{const s=e.getEntries(),n=s[s.length-1];n&&n.startTime>t&&(t=n.startTime,i=n)});try{e.observe({type:"largest-contentful-paint",buffered:!0});const s=()=>{i&&this.S({name:"LCP",value:t,rating:this.P("LCP",t),entries:[i],navigationType:this.C()})};document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&s()}),window.addEventListener("beforeunload",s)}catch(t){}}T(){const t=new PerformanceObserver(i=>{for(const e of i.getEntries()){const i=e,s=i.responseStart-i.requestStart;this.S({name:"TTFB",value:s,rating:this.P("TTFB",s),entries:[e],navigationType:this.C()}),t.disconnect();break}});try{t.observe({type:"navigation",buffered:!0})}catch(t){if("undefined"!=typeof performance&&performance.timing){const t=performance.timing.responseStart-performance.timing.requestStart;t>0&&this.S({name:"TTFB",value:t,rating:this.P("TTFB",t),entries:[],navigationType:"navigate"})}}}collectAll(){try{const t=performance.getEntriesByType("paint").find(t=>"first-contentful-paint"===t.name);t&&!this.l.has("FCP")&&this.S({name:"FCP",value:t.startTime,rating:this.P("FCP",t.startTime),entries:[t],navigationType:this.C()})}catch(t){}}destroy(){this.u.clear(),this.l.clear()}}class u{constructor(){this.A=[],this.o=new c,this.j=this.D(),this.M()}init(t){var i,e;if(!r())return;this.j.config={endpoint:"/api/collect",sampleRate:1,debug:!1,userProperties:{},offlineStorage:!0,batchSize:10,flushInterval:5e3,webVitals:!0,errorTracking:!0,cookieConsent:()=>!0,...t},(null===(e=(i=this.j.config).cookieConsent)||void 0===e?void 0:e.call(i))&&(Math.random()>this.j.config.sampleRate||(this.$(),this.U(),this.j.config.webVitals&&this.B(),this.j.config.errorTracking&&this.N(),this.R(),this.J(),this.j.isInitialized=!0,this.j.config.debug,this.page()))}track(t,e={}){if(!this.q())return;const s={type:t,timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,properties:o(e)};this.H(s),this.V(),this.j.config.debug}page(t,e,n={}){if(!this.q())return;const h=t||(r()?window.location.href:""),c=e||(r()?document.title:""),a=r()?document.referrer:"",u={type:"pageview",timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,url:h,title:c,referrer:a||void 0,utm:s(h),properties:o(n)};this.H(u),this.V(),this.j.config.debug}identify(t,i={}){this.q()&&(this.j.userId=t,this.o.setUserId(t),this.setUserProperties(i),this.j.config.debug)}setUserProperties(t){if(!this.q())return;const i=o(t);this.j.userProperties={...this.j.userProperties,...i},this.o.setUserProperties(this.j.userProperties),this.j.config.debug}async flush(){this.q()&&(await this.K(),this.j.config.debug)}reset(){var t;this.W&&clearInterval(this.W),this.X&&clearTimeout(this.X),this.o.clearSession(),this.j=this.D(),null===(t=this.j.config)||void 0===t||t.debug}getSessionId(){return this.j.sessionId}getUserId(){return this.j.userId||null}D(){return{config:{},sessionId:t(),deviceInfo:n(),userProperties:{},eventQueue:[],isInitialized:!1,lastActivity:i(),pageLoadTime:i()}}q(){return!!r()&&!!this.j.isInitialized}$(){const e=this.o.getSessionData(),s=i();e.sessionId&&e.lastActivity&&s-e.lastActivity<18e5?(this.j.sessionId=e.sessionId,this.j.userId=e.userId,this.j.userProperties=e.userProperties):(this.j.sessionId=t(),this.o.setSessionId(this.j.sessionId)),this.V()}U(){if(!this.j.config.offlineStorage)return;const t=this.o.getEventQueue();this.A=t,this.j.config.debug&&t.length}B(){this.G=new a,this.G.onMetric(t=>{const e={type:"web-vital",timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,name:t.name,value:t.value,rating:t.rating,navigationType:t.navigationType,properties:{entries:t.entries.length}};this.H(e)})}N(){this.Y=t=>{var e;const s={type:"error",timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,message:t.message||"Unknown error",stack:null===(e=t.error)||void 0===e?void 0:e.stack,filename:t.filename,lineno:t.lineno,colno:t.colno};this.H(s)},window.addEventListener("error",this.Y),window.addEventListener("unhandledrejection",t=>{var e,s;const n={type:"error",timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,message:(null===(e=t.reason)||void 0===e?void 0:e.message)||"Unhandled promise rejection",stack:null===(s=t.reason)||void 0===s?void 0:s.stack,properties:{type:"unhandledrejection"}};this.H(n)})}M(){r()&&(this.Z=function(t,i){let e;return(...s)=>{e||(t(...s),e=!0,setTimeout(()=>{e=!1},i))}}(t=>{var s;if(!this.q())return;const n=t.target;if(!n)return;const r={type:"click",timestamp:i(),sessionId:this.j.sessionId,userId:this.j.userId,selector:e(n),coordinates:{x:t.clientX,y:t.clientY},text:(null===(s=n.textContent)||void 0===s?void 0:s.slice(0,100))||void 0};this.H(r),this.V()},100),document.addEventListener("click",this.Z),this.tt=()=>{this.it()},window.addEventListener("beforeunload",this.tt),this.et=()=>{"hidden"===document.visibilityState&&this.it()},document.addEventListener("visibilitychange",this.et))}R(){this.W&&clearInterval(this.W),this.W=window.setInterval(()=>{this.K().catch(()=>{})},this.j.config.flushInterval)}J(){this.X&&clearTimeout(this.X),this.X=window.setTimeout(()=>{this.j.sessionId=t(),this.o.setSessionId(this.j.sessionId),this.j.config.debug},18e5)}H(t){const e={event:t,retries:0,timestamp:i()};this.A.push(e),this.j.config.offlineStorage&&this.o.addToQueue(e),this.A.length>=this.j.config.batchSize&&this.K().catch(()=>{})}V(){this.j.lastActivity=i(),this.o.setLastActivity(this.j.lastActivity),this.J()}async K(){if(0===this.A.length)return;const t=[...this.A],e={projectId:this.j.config.projectId,sessionId:this.j.sessionId,userId:this.j.userId,userProperties:this.j.userProperties,deviceInfo:this.j.deviceInfo,events:t.map(t=>t.event),timestamp:i()};try{const i=await fetch(this.j.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP ${i.status}`);this.A=this.A.filter(i=>!t.some(t=>t.timestamp===i.timestamp)),this.j.config.offlineStorage&&this.o.removeFromQueue(t),this.j.config.debug}catch(i){t.forEach(t=>{if(t.retries++,t.retries>=3){const i=this.A.findIndex(i=>i.timestamp===t.timestamp);i>=0&&this.A.splice(i,1)}}),this.j.config.debug}}it(){if(0===this.A.length)return;const t={projectId:this.j.config.projectId,sessionId:this.j.sessionId,userId:this.j.userId,userProperties:this.j.userProperties,deviceInfo:this.j.deviceInfo,events:this.A.map(t=>t.event),timestamp:i()};try{if(navigator.sendBeacon)navigator.sendBeacon(this.j.config.endpoint,JSON.stringify(t));else{const i=new XMLHttpRequest;i.open("POST",this.j.config.endpoint,!1),i.setRequestHeader("Content-Type","application/json"),i.send(JSON.stringify(t))}this.A=[],this.j.config.offlineStorage&&this.o.setEventQueue([])}catch(t){this.j.config.debug}}destroy(){var t;this.W&&clearInterval(this.W),this.X&&clearTimeout(this.X),this.Z&&document.removeEventListener("click",this.Z),this.Y&&window.removeEventListener("error",this.Y),this.tt&&window.removeEventListener("beforeunload",this.tt),this.et&&document.removeEventListener("visibilitychange",this.et),null===(t=this.G)||void 0===t||t.destroy(),this.it()}}function d(){return new u}function l(){if("undefined"!=typeof window&&window.aiAnalytics&&!Array.isArray(window.aiAnalytics))return;const t=d();((null===window||void 0===window?void 0:window.aiAnalytics)||[]).forEach(({method:i,args:e})=>{if("function"==typeof t[i])try{t[i](...e)}catch(t){}}),"undefined"!=typeof window&&(window.aiAnalytics=t)}"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",l):setTimeout(l,0)),"undefined"!=typeof module&&module.exports&&(module.exports={createTracker:d,Tracker:u}),function(t){if(t.aiAnalytics&&!Array.isArray(t.aiAnalytics))return;t.aiAnalytics=t.aiAnalytics||[],t.aiAnalyticsQ=t.aiAnalyticsQ||[];["init","track","page","identify","setUserProperties","flush","reset"].forEach(i=>{t.aiAnalytics[i]=(...e)=>function(i,...e){Array.isArray(t.aiAnalytics)?t.aiAnalytics.push({method:i,args:e}):"function"==typeof t.aiAnalytics[i]&&t.aiAnalytics[i](...e)}(i,...e)})}("undefined"!=typeof window?window:{});export{u as Tracker,d as createTracker};
