# AIウェブ分析システム 開発環境構築ガイド

## はじめに
このガイドでは、AIウェブ分析システムの開発環境を構築する手順を説明します。
初めての方でも迷わず環境構築できるよう、詳細な手順を記載しています。

---

## 必要なソフトウェア

### 1. 基本ツール
- **Node.js**: v18.0.0 以上（推奨: v20.10.0）
- **npm**: v9.0.0 以上
- **Git**: v2.30.0 以上
- **Docker Desktop**: v4.0.0 以上
- **VSCode**: 最新版（推奨エディタ）

### 2. インストール手順

#### macOS
```bash
# Homebrewのインストール（未インストールの場合）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Node.jsのインストール
brew install node@20

# Dockerのインストール
brew install --cask docker

# その他ツール
brew install git postgresql redis
```

#### Windows (WSL2推奨)
```bash
# WSL2のインストール
wsl --install

# Ubuntu内でNode.jsをインストール
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Dockerのインストール
# Docker Desktop for Windowsをダウンロードしてインストール
# https://www.docker.com/products/docker-desktop
```

---

## プロジェクトセットアップ

### 1. リポジトリのクローン
```bash
# プロジェクトディレクトリの作成
mkdir ~/projects
cd ~/projects

# リポジトリのクローン（実際のURLに置き換え）
git clone https://github.com/your-org/ai-web-analytics.git
cd ai-web-analytics
```

### 2. 初期設定スクリプトの実行
```bash
# 実行権限を付与
chmod +x scripts/setup.sh

# セットアップスクリプトの実行
./scripts/setup.sh
```

### 3. 手動セットアップ（スクリプトが動作しない場合）

#### 環境変数の設定
```bash
# .env.localファイルの作成
cp .env.example .env.local

# .env.localを編集
nano .env.local
```

**.env.local の内容例**
```env
# アプリケーション設定
NODE_ENV=development
PORT=3000
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3001

# データベース設定
DATABASE_URL=postgresql://analytics:password@localhost:5432/analytics_dev
REDIS_URL=redis://localhost:6379

# 認証設定
JWT_SECRET=your-super-secret-jwt-key-change-this
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# OpenAI設定（AI分析用）
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
OPENAI_MODEL=gpt-3.5-turbo

# メール設定（開発環境ではMailtrapを推奨）
SMTP_HOST=smtp.mailtrap.io
SMTP_PORT=2525
SMTP_USER=your-mailtrap-user
SMTP_PASS=your-mailtrap-pass
EMAIL_FROM=noreply@ai-analytics.dev

# AWS設定（ローカルではLocalStackを使用）
AWS_REGION=ap-northeast-1
AWS_ACCESS_KEY_ID=test
AWS_SECRET_ACCESS_KEY=test
S3_BUCKET=ai-analytics-dev

# セキュリティ設定
CORS_ORIGIN=http://localhost:3000
SESSION_SECRET=your-session-secret-change-this

# 監視・ログ設定
LOG_LEVEL=debug
SENTRY_DSN=
```

#### 依存関係のインストール
```bash
# ルートディレクトリで実行
npm install

# フロントエンドの依存関係
cd frontend
npm install

# バックエンドの依存関係
cd ../backend
npm install

# Pythonの依存関係（AI分析エンジン用）
cd ../ai-engine
python -m venv venv
source venv/bin/activate  # Windowsの場合: venv\Scripts\activate
pip install -r requirements.txt
```

---

## Docker環境の構築

### 1. docker-compose.yml の作成
```yaml
version: '3.8'

services:
  # PostgreSQLデータベース
  postgres:
    image: postgres:15.5-alpine
    container_name: ai-analytics-postgres
    environment:
      POSTGRES_USER: analytics
      POSTGRES_PASSWORD: password
      POSTGRES_DB: analytics_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U analytics"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis（キャッシュ・セッション管理）
  redis:
    image: redis:7.2-alpine
    container_name: ai-analytics-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LocalStack（AWS サービスのローカルエミュレーション）
  localstack:
    image: localstack/localstack:latest
    container_name: ai-analytics-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,cloudfront
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - localstack_data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock

  # Mailhog（開発用メールサーバー）
  mailhog:
    image: mailhog/mailhog:latest
    container_name: ai-analytics-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI

volumes:
  postgres_data:
  redis_data:
  localstack_data:
```

### 2. Dockerコンテナの起動
```bash
# すべてのサービスを起動
docker-compose up -d

# 特定のサービスのみ起動
docker-compose up -d postgres redis

# ログの確認
docker-compose logs -f

# サービスの停止
docker-compose down

# データも含めて完全に削除
docker-compose down -v
```

### 3. データベースの初期化
```bash
# マイグレーションファイルの実行
npm run db:migrate

# シードデータの投入（開発用データ）
npm run db:seed

# データベースに接続して確認
docker exec -it ai-analytics-postgres psql -U analytics -d analytics_dev
```

---

## VSCode の設定

### 1. 推奨拡張機能
**.vscode/extensions.json**
```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "dsznajder.es7-react-js-snippets",
    "prisma.prisma",
    "ms-python.python",
    "ms-azuretools.vscode-docker",
    "GitHub.copilot",
    "eamodio.gitlens",
    "christian-kohler.path-intellisense",
    "formulahendry.auto-rename-tag",
    "steoates.autoimport",
    "wix.vscode-import-cost",
    "kamikillerto.vscode-colorize",
    "oderwat.indent-rainbow"
  ]
}
```

### 2. VSCode 設定
**.vscode/settings.json**
```json
{
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "editor.tabSize": 2,
  "editor.rulers": [80, 120],
  "editor.bracketPairColorization.enabled": true,
  "editor.guides.bracketPairs": true,
  
  "files.autoSave": "onFocusChange",
  "files.trimTrailingWhitespace": true,
  "files.insertFinalNewline": true,
  
  "typescript.updateImportsOnFileMove.enabled": "always",
  "typescript.preferences.importModuleSpecifier": "relative",
  
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact"
  ],
  
  "tailwindCSS.includeLanguages": {
    "typescript": "javascript",
    "typescriptreact": "javascript"
  },
  
  "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.organizeImports": true
    }
  },
  
  "git.autofetch": true,
  "git.confirmSync": false,
  
  "terminal.integrated.env.osx": {
    "FIG_NEW_SESSION": "1"
  }
}
```

### 3. デバッグ設定
**.vscode/launch.json**
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/frontend/node_modules/.bin/next",
      "args": ["dev"],
      "cwd": "${workspaceFolder}/frontend",
      "env": {
        "NODE_OPTIONS": "--inspect"
      },
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen",
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Node.js: debug backend",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/backend/src/server.js",
      "cwd": "${workspaceFolder}/backend",
      "restart": true,
      "env": {
        "NODE_ENV": "development"
      },
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    },
    {
      "name": "Python: Flask",
      "type": "python",
      "request": "launch",
      "module": "flask",
      "env": {
        "FLASK_APP": "app.py",
        "FLASK_ENV": "development"
      },
      "args": ["run", "--no-debugger"],
      "jinja": true,
      "cwd": "${workspaceFolder}/ai-engine"
    },
    {
      "name": "Jest: current file",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/jest",
      "args": ["${fileBasename}", "--coverage=false"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ],
  "compounds": [
    {
      "name": "Full Stack",
      "configurations": ["Next.js: debug", "Node.js: debug backend"],
      "stopAll": true
    }
  ]
}
```

---

## 開発サーバーの起動

### 1. 個別起動
```bash
# フロントエンド（Next.js）
cd frontend
npm run dev
# http://localhost:3000 でアクセス

# バックエンド（Node.js）
cd backend
npm run dev
# http://localhost:3001 でAPIアクセス

# AI分析エンジン（Python）
cd ai-engine
source venv/bin/activate  # Windowsの場合: venv\Scripts\activate
python app.py
# http://localhost:5000 でアクセス
```

### 2. 一括起動（推奨）
```bash
# プロジェクトルートで実行
npm run dev:all

# または各ターミナルタブで個別に起動
```

### 3. 起動確認
以下のURLにアクセスして動作確認：
- フロントエンド: http://localhost:3000
- バックエンドAPI: http://localhost:3001/api/health
- AI分析エンジン: http://localhost:5000/health
- Mailhog: http://localhost:8025
- データベース管理: pgAdmin等で localhost:5432 に接続

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. npm install でエラーが発生
```bash
# キャッシュクリア
npm cache clean --force

# node_modulesを削除して再インストール
rm -rf node_modules package-lock.json
npm install
```

#### 2. ポートが既に使用されている
```bash
# 使用中のポートを確認（Mac/Linux）
lsof -i :3000
lsof -i :3001
lsof -i :5432

# プロセスを終了
kill -9 <PID>

# Windowsの場合
netstat -ano | findstr :3000
taskkill /PID <PID> /F
```

#### 3. Dockerコンテナが起動しない
```bash
# Dockerサービスの確認
docker info

# コンテナの状態確認
docker ps -a

# ログ確認
docker logs ai-analytics-postgres

# 全てリセット
docker-compose down -v
docker system prune -a
docker-compose up -d
```

#### 4. データベース接続エラー
```bash
# PostgreSQLの起動確認
docker exec ai-analytics-postgres pg_isready

# 接続テスト
docker exec -it ai-analytics-postgres psql -U analytics -d analytics_dev -c "SELECT 1"

# 環境変数の確認
echo $DATABASE_URL
```

---

## 開発のベストプラクティス

### 1. ブランチ運用
```bash
# 新機能の開発
git checkout -b feature/add-new-dashboard

# バグ修正
git checkout -b fix/data-collection-error

# 作業前に最新を取得
git checkout develop
git pull origin develop
git checkout -b feature/your-feature
```

### 2. コミット前の確認
```bash
# ESLintチェック
npm run lint

# TypeScriptチェック
npm run type-check

# テスト実行
npm test

# 全チェック実行
npm run validate
```

### 3. 便利なエイリアス設定
```bash
# ~/.zshrc or ~/.bashrc に追加
alias dc='docker-compose'
alias dcup='docker-compose up -d'
alias dcdown='docker-compose down'
alias dclogs='docker-compose logs -f'
alias nr='npm run'
alias nrd='npm run dev'
alias nrt='npm run test'
```

---

## 次のステップ

環境構築が完了したら、以下のドキュメントを参照してください：

1. **開発ドキュメント_詳細仕様.md** - 開発タスクとコーディング規約
2. **要件定義書_AIウェブ分析システム.md** - システムの詳細仕様
3. **API仕様書** - バックエンドAPIの詳細

質問や問題がある場合は、チームのSlackチャンネルまたはGitHub Issuesで相談してください。

Happy Coding! 🚀