<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPæ”¹å–„åˆ†æã‚·ã‚¹ãƒ†ãƒ  - æœ¬ç•ªç‰ˆ</title>
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'nonce-production-2024' https://cdn.tailwindcss.com; 
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com;
                   img-src 'self' data:;
                   connect-src 'self' https:;">
    
    <!-- å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆSRIå¯¾å¿œï¼‰ -->
    <script src="https://cdn.tailwindcss.com" 
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
            crossorigin="anonymous"
            nonce="production-2024"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" 
          rel="stylesheet"
          integrity="sha384-mPE+XZwLMqMYh0F5xPqkjjE8cxjNNX9kJbVvJ5xvZt8qnMwQg2hR7+8P9xLO7P8x"
          crossorigin="anonymous">
    
    <style nonce="production-2024">
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background: #f8f9fa;
        }
        .card-hover {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #3b82f6; }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body>
    <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">ğŸ¯</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">HPæ”¹å–„åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p class="text-xs text-gray-600">å•é¡Œã‚’è¦‹ã¤ã‘ã¦ã€æˆæœã‚’æœ€å¤§åŒ–</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                    <span class="text-sm text-gray-600">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æä¸­</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-6xl mx-auto px-6 py-8">
        
        <!-- ç¾åœ¨ã®çŠ¶æ…‹ã‚µãƒãƒªãƒ¼ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900" id="mainMetric">ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...</h2>
                    <p class="text-gray-600 mt-1" id="metricDetails">ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã„ã¾ã™</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">æ”¹å–„å¯èƒ½ãªæˆæœ</p>
                    <p class="text-3xl font-bold text-purple-600" id="potentialImprovement">åˆ†æä¸­</p>
                </div>
            </div>
        </div>

        <!-- æ¤œå‡ºã•ã‚ŒãŸå•é¡Œç‚¹ -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <span class="text-red-500 mr-2">âš ï¸</span>
                æ¤œå‡ºã•ã‚ŒãŸå•é¡Œç‚¹
            </h3>
            
            <div id="detectedIssues" class="space-y-4">
                <div class="text-gray-500 text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­ã§ã™...</p>
                    <p class="text-sm mt-2">ã‚ãªãŸã®ã‚µã‚¤ãƒˆã®å•é¡Œç‚¹ã‚’è‡ªå‹•æ¤œå‡ºã—ã¦ã„ã¾ã™</p>
                </div>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸš€ æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="quickActions" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center py-8 text-gray-500">
                    å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã‚‹ã¨ã€æ”¹å–„ç­–ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            </div>
        </div>

    </main>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">è©³ç´°åˆ†æ</h3>
                </div>
                <div id="modalContent" class="p-8">
                    <!-- å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŒ¿å…¥ -->
                </div>
                <div class="p-6 border-t">
                    <button onclick="HPAnalytics.UI.closeModal()" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition-colors">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script nonce="production-2024">
        // ã‚»ã‚­ãƒ¥ã‚¢ãªåˆ†æUIã‚·ã‚¹ãƒ†ãƒ 
        const HPAnalytics = (function() {
            'use strict';
            
            // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆå¤‰æ•°
            let analysisData = null;
            let updateInterval = null;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
            function sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            // å®‰å…¨ãªDOMæ“ä½œ
            function safeSetContent(element, content) {
                if (!element) return;
                element.textContent = '';
                if (typeof content === 'string') {
                    element.textContent = content;
                } else if (content instanceof HTMLElement) {
                    element.appendChild(content);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿åˆ†æ
            function analyzeTrackingData() {
                try {
                    const rawData = localStorage.getItem('hp_analytics_data');
                    if (!rawData) return null;
                    
                    const data = JSON.parse(rawData);
                    if (!Array.isArray(data) || data.length === 0) return null;
                    
                    return processAnalysisData(data);
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }
            
            // åˆ†æãƒ‡ãƒ¼ã‚¿å‡¦ç†
            function processAnalysisData(data) {
                const analysis = {
                    totalSessions: data.length,
                    totalEvents: 0,
                    formAbandons: 0,
                    formStarts: 0,
                    errors: 0,
                    avgLoadTime: 0,
                    issues: []
                };
                
                let totalLoadTime = 0;
                let loadTimeCount = 0;
                
                data.forEach(function(session) {
                    if (session.events && Array.isArray(session.events)) {
                        analysis.totalEvents += session.events.length;
                        
                        session.events.forEach(function(event) {
                            if (event.name === 'form_start') analysis.formStarts++;
                            if (event.name === 'form_abandon') analysis.formAbandons++;
                        });
                    }
                    
                    if (session.errors && Array.isArray(session.errors)) {
                        analysis.errors += session.errors.length;
                    }
                    
                    if (session.performance && session.performance.loadTime > 0) {
                        totalLoadTime += session.performance.loadTime;
                        loadTimeCount++;
                    }
                });
                
                analysis.avgLoadTime = loadTimeCount > 0 ? totalLoadTime / loadTimeCount : 0;
                
                // å•é¡Œç‚¹ã®æ¤œå‡º
                analysis.issues = detectIssues(analysis);
                
                return analysis;
            }
            
            // å•é¡Œæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
            function detectIssues(analysis) {
                const issues = [];
                
                // ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãƒã‚§ãƒƒã‚¯
                if (analysis.formStarts > 0) {
                    const abandonRate = (analysis.formAbandons / analysis.formStarts) * 100;
                    if (abandonRate > 50) {
                        issues.push({
                            severity: 'high',
                            type: 'form_abandon',
                            title: 'ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãŒé«˜ã„',
                            description: `ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãŒ${Math.round(abandonRate)}%ã¨é«˜ããªã£ã¦ã„ã¾ã™ã€‚`,
                            impact: Math.round(analysis.formAbandons * 0.8) + 'ä»¶ã®å•ã„åˆã‚ã›æ©Ÿä¼šã‚’æå¤±',
                            solutions: [
                                'å¿…é ˆé …ç›®ã‚’æœ€å°é™ã«å‰Šæ¸›',
                                'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…',
                                'ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¿½åŠ '
                            ]
                        });
                    }
                }
                
                // ã‚¨ãƒ©ãƒ¼æ¤œå‡º
                if (analysis.errors > 0) {
                    issues.push({
                        severity: 'high',
                        type: 'js_errors',
                        title: 'JavaScriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ',
                        description: `${analysis.errors}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`,
                        impact: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å¤§å¹…ãªæ‚ªåŒ–',
                        solutions: [
                            'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°èª¿æŸ»',
                            'ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®ç¢ºèª',
                            'ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–'
                        ]
                    });
                }
                
                // ãƒšãƒ¼ã‚¸é€Ÿåº¦ãƒã‚§ãƒƒã‚¯
                if (analysis.avgLoadTime > 3000) {
                    issues.push({
                        severity: 'medium',
                        type: 'slow_loading',
                        title: 'ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ãŒé…ã„',
                        description: `å¹³å‡èª­ã¿è¾¼ã¿æ™‚é–“ãŒ${Math.round(analysis.avgLoadTime/1000)}ç§’ã§ã™ã€‚`,
                        impact: 'ç›´å¸°ç‡ã®å¢—åŠ ã¨SEOã¸ã®æ‚ªå½±éŸ¿',
                        solutions: [
                            'ç”»åƒã®æœ€é©åŒ–ã¨åœ§ç¸®',
                            'CDNã®å°å…¥',
                            'ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®è¦‹ç›´ã—'
                        ]
                    });
                }
                
                return issues;
            }
            
            // UIæ›´æ–°
            function updateUI(analysis) {
                if (!analysis) {
                    document.getElementById('mainMetric').textContent = 'ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...';
                    document.getElementById('metricDetails').textContent = 'ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
                    document.getElementById('potentialImprovement').textContent = 'åˆ†æä¸­';
                    return;
                }
                
                // ãƒ¡ã‚¤ãƒ³æŒ‡æ¨™æ›´æ–°
                const mainMetricEl = document.getElementById('mainMetric');
                const metricDetailsEl = document.getElementById('metricDetails');
                const potentialEl = document.getElementById('potentialImprovement');
                
                if (analysis.formStarts > 0) {
                    const successRate = Math.round(((analysis.formStarts - analysis.formAbandons) / analysis.formStarts) * 100);
                    safeSetContent(mainMetricEl, `ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡: ${successRate}%`);
                    safeSetContent(metricDetailsEl, `${analysis.totalSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ ${analysis.formStarts}ä»¶ã®ãƒ•ã‚©ãƒ¼ãƒ é–‹å§‹`);
                } else {
                    safeSetContent(mainMetricEl, `${analysis.totalSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†ææ¸ˆã¿`);
                    safeSetContent(metricDetailsEl, `${analysis.totalEvents}å€‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚’è¨˜éŒ²`);
                }
                
                const improvementCount = analysis.issues.filter(i => i.severity === 'high').length;
                safeSetContent(potentialEl, `${improvementCount}å€‹ã®æ”¹å–„ç‚¹`);
                
                // å•é¡Œç‚¹è¡¨ç¤º
                updateIssuesDisplay(analysis.issues);
            }
            
            // å•é¡Œç‚¹è¡¨ç¤ºæ›´æ–°
            function updateIssuesDisplay(issues) {
                const container = document.getElementById('detectedIssues');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (issues.length === 0) {
                    const noIssues = document.createElement('div');
                    noIssues.className = 'text-green-600 text-center py-8';
                    noIssues.innerHTML = 'âœ… ç¾åœ¨ã€é‡å¤§ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    container.appendChild(noIssues);
                    return;
                }
                
                issues.forEach(function(issue) {
                    const issueEl = document.createElement('div');
                    issueEl.className = `bg-white rounded-lg shadow-sm p-6 priority-${issue.severity} card-hover fade-in`;
                    
                    const severityColors = {
                        high: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200' },
                        medium: { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200' },
                        low: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200' }
                    };
                    
                    const colors = severityColors[issue.severity];
                    const severityText = issue.severity === 'high' ? 'ç·Šæ€¥' : issue.severity === 'medium' ? 'é‡è¦' : 'æ”¹å–„æ¨å¥¨';
                    const icon = issue.severity === 'high' ? 'ğŸš¨' : issue.severity === 'medium' ? 'âš ï¸' : 'ğŸ’¡';
                    
                    issueEl.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="${colors.bg} ${colors.text} text-xs font-semibold px-2 py-1 rounded">${severityText}</span>
                                    <h4 class="text-lg font-semibold text-gray-900">${sanitizeHTML(issue.title)}</h4>
                                </div>
                                <p class="text-gray-600 mb-3">${sanitizeHTML(issue.description)}</p>
                                <div class="flex items-center justify-between">
                                    <p class="text-sm ${colors.text} font-medium">
                                        å½±éŸ¿: ${sanitizeHTML(issue.impact)}
                                    </p>
                                    <button onclick="HPAnalytics.UI.showIssueDetail('${issue.type}')" class="text-blue-600 text-sm font-medium hover:underline flex items-center">
                                        è©³ç´°ã‚’è¦‹ã‚‹
                                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(issueEl);
                });
            }
            
            // åˆæœŸåŒ–
            function init() {
                analysisData = analyzeTrackingData();
                updateUI(analysisData);
                
                // å®šæœŸæ›´æ–°ï¼ˆ5ç§’é–“éš”ï¼‰
                updateInterval = setInterval(function() {
                    const newData = analyzeTrackingData();
                    if (newData) {
                        analysisData = newData;
                        updateUI(analysisData);
                    }
                }, 5000);
            }
            
            // UIåˆ¶å¾¡
            const UI = {
                showIssueDetail: function(issueType) {
                    if (!analysisData || !analysisData.issues) return;
                    
                    const issue = analysisData.issues.find(i => i.type === issueType);
                    if (!issue) return;
                    
                    const modal = document.getElementById('detailModal');
                    const title = document.getElementById('modalTitle');
                    const content = document.getElementById('modalContent');
                    
                    safeSetContent(title, issue.title + 'ã®è©³ç´°');
                    
                    const detailHTML = `
                        <div class="space-y-6">
                            <div class="bg-${issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'orange' : 'blue'}-50 border border-${issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'orange' : 'blue'}-200 rounded-lg p-4">
                                <p class="text-${issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'orange' : 'blue'}-800">
                                    <strong>å½±éŸ¿:</strong> ${sanitizeHTML(issue.impact)}
                                </p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„ç­–</h4>
                                <div class="space-y-2">
                                    ${issue.solutions.map((solution, index) => 
                                        `<div class="flex items-start">
                                            <span class="text-green-500 mr-2">â€¢</span>
                                            <span>${sanitizeHTML(solution)}</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = detailHTML;
                    modal.classList.remove('hidden');
                },
                
                closeModal: function() {
                    const modal = document.getElementById('detailModal');
                    modal.classList.add('hidden');
                }
            };
            
            // ãƒ‘ãƒ–ãƒªãƒƒã‚¯API
            return {
                init: init,
                UI: UI,
                getAnalysis: function() { return analysisData; }
            };
        })();

        // åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', HPAnalytics.init);
        } else {
            HPAnalytics.init();
        }
        
        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                HPAnalytics.UI.closeModal();
            }
        });
    </script>
</body>
</html>