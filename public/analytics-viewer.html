<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPæ”¹å–„åˆ†æã‚·ã‚¹ãƒ†ãƒ  - åé›†ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .json-viewer {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-6">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">ğŸ“Š åé›†ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
            <p class="text-gray-600">
                ã‚ãªãŸã®ã‚µã‚¤ãƒˆã‹ã‚‰åé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã—ã€å•é¡Œç‚¹ã‚’ç™ºè¦‹ã§ãã¾ã™ã€‚
            </p>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600 mb-1">ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                <div class="text-2xl font-bold text-gray-900" id="totalSessions">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600 mb-1">ç·ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼</div>
                <div class="text-2xl font-bold text-gray-900" id="totalPageViews">0</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600 mb-1">ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡</div>
                <div class="text-2xl font-bold text-red-600" id="formAbandonRate">0%</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-sm text-gray-600 mb-1">å¹³å‡æ»åœ¨æ™‚é–“</div>
                <div class="text-2xl font-bold text-blue-600" id="avgTimeOnPage">0ç§’</div>
            </div>
        </div>

        <!-- å•é¡Œç‚¹ã®è‡ªå‹•æ¤œå‡º -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œç‚¹</h2>
            <div id="detectedIssues" class="space-y-4">
                <div class="text-gray-500 text-center py-8">
                    ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­ã§ã™...
                </div>
            </div>
        </div>

        <!-- è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">ğŸ” è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
                <div class="space-x-2">
                    <button onclick="refreshData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        æ›´æ–°
                    </button>
                    <button onclick="clearData()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                        ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
            
            <div class="json-viewer" id="rawDataViewer">
                <pre>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</pre>
            </div>
        </div>

    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿åˆ†æã¨è¡¨ç¤º
        function analyzeData() {
            const rawData = localStorage.getItem('hp_analytics_data');
            
            if (!rawData) {
                document.getElementById('rawDataViewer').innerHTML = '<pre>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¿ã‚°ã‚’è¨­ç½®ã—ã¦ã‚µã‚¤ãƒˆã‚’é–²è¦§ã—ã¦ãã ã•ã„ã€‚</pre>';
                return;
            }

            try {
                const data = JSON.parse(rawData);
                
                // åŸºæœ¬çµ±è¨ˆ
                const totalSessions = data.length;
                const totalPageViews = data.reduce((sum, session) => sum + session.pageViews.length, 0);
                
                // ãƒ•ã‚©ãƒ¼ãƒ åˆ†æ
                let formStarts = 0;
                let formAbandons = 0;
                data.forEach(session => {
                    session.events.forEach(event => {
                        if (event.name === 'form_start') formStarts++;
                        if (event.name === 'form_abandon') formAbandons++;
                    });
                });
                const formAbandonRate = formStarts > 0 ? Math.round((formAbandons / formStarts) * 100) : 0;
                
                // å¹³å‡æ»åœ¨æ™‚é–“
                let totalTime = 0;
                let pageCount = 0;
                data.forEach(session => {
                    session.pageViews.forEach(pv => {
                        if (pv.timeOnPage > 0) {
                            totalTime += pv.timeOnPage;
                            pageCount++;
                        }
                    });
                });
                const avgTimeOnPage = pageCount > 0 ? Math.round(totalTime / pageCount / 1000) : 0;
                
                // UIæ›´æ–°
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('totalPageViews').textContent = totalPageViews;
                document.getElementById('formAbandonRate').textContent = formAbandonRate + '%';
                document.getElementById('avgTimeOnPage').textContent = avgTimeOnPage + 'ç§’';
                
                // å•é¡Œç‚¹ã®æ¤œå‡º
                detectIssues(data, formAbandonRate, avgTimeOnPage);
                
                // ç”Ÿãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                document.getElementById('rawDataViewer').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
            } catch (e) {
                // Silent error handling for production security
                document.getElementById('rawDataViewer').innerHTML = '<pre class="text-red-400">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</pre>';
            }
        }

        // å•é¡Œç‚¹ã®è‡ªå‹•æ¤œå‡º
        function detectIssues(data, formAbandonRate, avgTimeOnPage) {
            const issues = [];
            
            // ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãƒã‚§ãƒƒã‚¯
            if (formAbandonRate > 50) {
                issues.push({
                    severity: 'high',
                    title: 'ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãŒç•°å¸¸ã«é«˜ã„',
                    description: `ãƒ•ã‚©ãƒ¼ãƒ é›¢è„±ç‡ãŒ${formAbandonRate}%ã¨éå¸¸ã«é«˜ããªã£ã¦ã„ã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã®é …ç›®æ•°å‰Šæ¸›ã‚„å…¥åŠ›æ”¯æ´ã®å®Ÿè£…ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`,
                    impact: 'å•ã„åˆã‚ã›æ•°ã®å¤§å¹…ãªæ©Ÿä¼šæå¤±'
                });
            }
            
            // ã‚¨ãƒ©ãƒ¼æ¤œå‡º
            let errorCount = 0;
            data.forEach(session => {
                errorCount += session.errors.length;
            });
            if (errorCount > 0) {
                issues.push({
                    severity: 'high',
                    title: 'JavaScriptã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ',
                    description: `${errorCount}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’è‘—ã—ãæãªã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`,
                    impact: 'ã‚µã‚¤ãƒˆæ©Ÿèƒ½ã®ä¸å…·åˆã«ã‚ˆã‚‹é›¢è„±'
                });
            }
            
            // ãƒšãƒ¼ã‚¸é€Ÿåº¦ãƒã‚§ãƒƒã‚¯
            let slowPages = 0;
            data.forEach(session => {
                if (session.performance.loadTime > 3000) {
                    slowPages++;
                }
            });
            if (slowPages > 0) {
                issues.push({
                    severity: 'medium',
                    title: 'ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ãŒé…ã„',
                    description: `${slowPages}ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§3ç§’ä»¥ä¸Šã®èª­ã¿è¾¼ã¿æ™‚é–“ã‚’è¨˜éŒ²ã€‚ç”»åƒæœ€é©åŒ–ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`,
                    impact: 'ç›´å¸°ç‡ã®å¢—åŠ '
                });
            }
            
            // æ»åœ¨æ™‚é–“ãƒã‚§ãƒƒã‚¯
            if (avgTimeOnPage < 30 && avgTimeOnPage > 0) {
                issues.push({
                    severity: 'medium',
                    title: 'æ»åœ¨æ™‚é–“ãŒçŸ­ã„',
                    description: `å¹³å‡æ»åœ¨æ™‚é–“ãŒ${avgTimeOnPage}ç§’ã¨çŸ­ãã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒååˆ†ã«é–²è¦§ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`,
                    impact: 'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã®ä½ä¸‹'
                });
            }
            
            // å•é¡Œç‚¹ã®è¡¨ç¤º
            const issuesContainer = document.getElementById('detectedIssues');
            if (issues.length === 0) {
                issuesContainer.innerHTML = '<div class="text-green-600 text-center py-8">âœ… ç¾åœ¨ã€é‡å¤§ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
            } else {
                issuesContainer.innerHTML = issues.map(issue => `
                    <div class="border-l-4 ${issue.severity === 'high' ? 'border-red-500 bg-red-50' : 'border-orange-500 bg-orange-50'} p-4 rounded">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">${issue.severity === 'high' ? 'ğŸš¨' : 'âš ï¸'}</span>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900">${issue.title}</h3>
                                <p class="text-gray-700 mt-1">${issue.description}</p>
                                <p class="text-sm ${issue.severity === 'high' ? 'text-red-600' : 'text-orange-600'} mt-2">
                                    å½±éŸ¿: ${issue.impact}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshData() {
            analyzeData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearData() {
            if (confirm('åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('hp_analytics_data');
                analyzeData();
            }
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', () => {
            analyzeData();
            // 5ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
            setInterval(analyzeData, 5000);
        });
    </script>
</body>
</html>